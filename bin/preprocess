#!/usr/bin/env ruby

require 'nokogiri'

class Equation < String
  def to_image 
    str = self.inspect[1..-2]
    str.sub!(/\label{Eq:I:(\d+):(\d+)}/,'tag{\1:\2}')
    bin = File.dirname(__FILE__)
    cmd = [bin, 'eq2img'].join('/')
    IO.popen([cmd, str]).read.chomp
  end
  def for_html
    ['<img src="', self.to_image, '">'].join
  end
end

class SVG < String
  def to_png
    res = sub(/svg$/,'png')
    opts = '-density 120 +antialias -background none'
    system ['convert', opts, self, res].join(?\s)
    return res
  end
end

class String
  def slim
    html = self.to_html.css('.document').children
    html.css('footer').remove
    return html.to_html
  end
  def prettify
    html = self.to_html
    html.css('span.tag').each do |tag| 
      tag.content = tag.content << ?\s 
    end
    return html.to_html
  end
  def tex2png
    delimiters = [
      /\\begin{equation\*?}.*?\\end{equation\*?}/m,
      /\\begin{align\*?}.*?\\end{align\*?}/m,
      /\$+.*?\$+/m
    ]
    delimiters.each do |pattern|
      gsub!(pattern) do |equation| 
        Equation.new(equation).for_html
      end
    end
    return self
  end
  def svg2png
    gsub!(/(?<=src=").+\.svg(?=">)/) do |path|
      SVG.new(path).to_png
    end
    return self
  end
  def to_html
    Nokogiri::HTML self
  end
end

ARGV.each do |html|
  output = File.read(html).slim.prettify.tex2png.svg2png
  File.write html, output
end
